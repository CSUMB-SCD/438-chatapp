<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  </head>
      <body onunload="goodby()"; style="background-image: url('http://i0.kym-cdn.com/entries/icons/original/000/002/232/bullet_cat.jpg');
      background-repeat: no-repeat; background-size: 100%; overflow: hidden;" >
      <h1>{{ title }} Chat App</h1>
      <div id="chat-area" style="background-color: rgba(255, 255, 255, 0.4);
        position: absolute; overflow-y: auto; float: left; width: 50%; height: 50%;"/>
        <div id="input" style="float: left;">
        <form id="messageForm">
        <textarea id="message" style="position: fixed; top:65%; width: 44%; height: 25px; resize: none; font-size: 16px;"></textarea>
        <input type="submit" value="Send" id="input" style="position: fixed; top: 65%; left: 46%; font-size: 20px;" />
        </form>
      </div>
    <script>
        var connectionLength = 0;
        document.addEventListener("DOMContentLoaded", function(event) { 
            var socket = io.connect(); 
            var $messageForm = $("#messageForm"); 
            var $message = $("#message"); 
            var $chat = $("#chat-area");
            var $user = $("#listUsers");
            var $name = $("#name");
            var person = '';
            
            if(person == ''){
            person = prompt("Please enter your name");
            document.getElementById("welcome").innerHTML = person;
            console.log(person);
            }
            
            $messageForm.submit(function(e) {
                e.preventDefault();
                socket.emit('name', person);
                socket.emit('send message', $message.val());
                $message.val('');
            }); 
             
             socket.on('list', function(namePerson) {
             var text, fLen, fLen2, i, x, y;
             
   // This nested for loop shoud get rid of the dupplicats but its only working partialy
              fLen = namePerson.length;
              fLen2 = fLen - 1;
              for (x = 0; x < fLen2; x++){
              for (i = x + 1; i < fLen; i++){
                  if (namePerson[i] == namePerson[x]){
                      namePerson.splice(i, x);
                      }
                    }
                  }
              fLen = namePerson.length;
              fLen2 = fLen - 1;
              for (x = 0; x < fLen2; x++){
              for (i = x + 1; i < fLen; i++){
                  if (namePerson[i] == namePerson[x]){
                      namePerson.splice(i, x);
                      }
                    }
                  }
              fLen = namePerson.length;
              text = "<ul>";
              for (i = 0; i < fLen; i++) {
                  text += "<li>" + namePerson[i] + "</li>";
              }
              text += "</ul>";
              document.getElementById("listUsers").innerHTML = text;
             });
            
            socket.on('new message', function(data) {
            connectionLength = data.length;

              console.log("connection"); 
              $chat.append('<div class=name>' + data.name + '</div>: <div class=chat-message>' + data.msg + '</div><BR><BR>');
              document.getElementById("numUsers").innerHTML = data.users;
              
             });
             
            function goodby(){
            $messageForm.submit(function(e) {
              e.preventDefault();
              socket.emit('disconnect', person);
            });
          }
        });
    </script>
    </div>
    <div class="users", style="float: right;">
    <h2 >Connected users<h2 id="numUsers" />0</h2>
    <h2>User Name of Chat app<h2 id="welcome" /></h2>
    <h2> List of Users: </h2>
    <ul id="listUsers">
      <li></li>
    </ul>
    </div>
  </body>
</html>